var analyses_domain="https://analyses.huishoubao.com";var logreport_domain="https://logreport.huishoubao.com/hjxapps";(function(){var config={api:analyses_domain+"/api/v2/fe/add",business_name:"",report_name:""};var setConfig=function(data){if(typeof data!=="object"){return}for(var i in data){config[i]=data[i]}};var rate=(function(){var errorPool={};var errorCount=5;var errorIntervalTime=1000*1*60*5;var obtainMsgKey=function(msg){msg=msg||"";return generateSign(msg.replace(/\s+/g,""))};var selectiveComp=function(str){str=str.replace(/\/\\*/g,"");if(str.length>140){str=str.slice(0,60)+str.slice(90,130)}return str};var generateSign=function(value){if(!value){return value}if(typeof hex_md5!=="function"){return selectiveComp(value)}return hex_md5(value)};var add=function(options){var msgKey=obtainMsgKey(options.message);if(!errorPool[msgKey]){errorPool[msgKey]={timeStamp:Date.now(),count:1};return true}var oError=errorPool[msgKey];if(Date.now()-oError.timeStamp<errorIntervalTime){return false}oError.timeStamp=Date.now();oError.count++;if(oError.count>errorCount){return false}return true};return{add:add}})();var regx=/\:\/\/(.+)(\/)(\S*)(\))/;var filterEmpty=function(o){for(var i in o){if(o[i]===""||o[i]===null||o[i]===undefined||o[i]==="undefined"||o[i]==="null"){delete o[i]}}return o};var logreport=function(startTime,url,code){var apiUrl=url.split(analyses_domain)[1];var duration=Date.now()-startTime;var createTime=Date.now().toString().substr(0,10);var logreportUrl=logreport_domain+"/?1="+createTime+"=analysesV2SDK=123.207.235.17=analysesV2Server=123.207.235.17="+apiUrl+"="+code+"="+duration;if(!apiUrl){return}navigator.sendBeacon(logreportUrl)};var fetchTo=function(url,o){url=url||"";o=o||{};var xhr=new XMLHttpRequest,sendData={},options={type:o.type||"POST",data:o.data||{},success:o.success||function(){},error:o.error||function(){}};if(!url){return}xhr.timeout=30000;options.data.token=localStorage.getItem("analyses_token")||"";xhr.open(options.type,url,true);if(options.type==="POST"){sendData=JSON.stringify(options.data);xhr.setRequestHeader("Content-Type","application/json; charset=UTF-8")}var logreportStartTime=Date.now();xhr.send(sendData);xhr.onload=function(e){if((xhr.status>=200&&xhr.status<300)||xhr.status===304){try{var res=JSON.parse(xhr.responseText);logreport(logreportStartTime,url,res.code||0);if(res.code!==0){return}options.success(res);if(res.data&&res.data.sign){localStorage.setItem("analyses_token",res.data.sign)}}catch(err){}}else{logreport(logreportStartTime,url,xhr.status)}};xhr.onerror=function(e){logreport(logreportStartTime,url,-2)};xhr.ontimeout=function(e){logreport(logreportStartTime,url,-1)}};var errorReport={filterKey:["Script error","WeixinJSBridge","VectorLayer","logreport"],isCheckKeyToReport:function(errMsg){var isReport=true;if(!errMsg){return false}if(typeof errMsg==="object"){return false}this.filterKey.forEach(function(item){if(errMsg.indexOf(item)>-1){isReport=false}});return isReport},createErrorBody:function(options){var i,oReturn={url:location.href};for(i in options){oReturn[i]=options[i]}return oReturn},sendBefore:function(data){data.business_name=config.business_name;data.report_name=config.report_name;data.referer=document.referer;data.ua=navigator.userAgent||"";if(data.ua.indexOf("baidu.com")>-1||data.ua.indexOf("Baiduspider")>-1){return}fetchTo(config.api,{data:filterEmpty(data)})},obtainStack:function(str){if(!str){return{}}var i,arr=str.split(/\n/),firstLineFile=null,line=null,file=null,res;for(i=0;i<arr.length;i++){if(arr[i].indexOf(".js")>-1){firstLineFile=arr[i].replace(/\s+/,"");break}}if(!firstLineFile){return{}}try{res=firstLineFile.match(regx);if(res){res=res[3].split(":");file=res[0];line=res.slice(1).join(":")}}catch(err){}return{stack:str.replace(/(http|https):\/\/(\S*)\//g,""),line:line,file:file}},error:function(){var that=this;console.error=function(data){var result,stackResult,params;if(typeof data==="string"){data={message:data}}result=that.isCheckKeyToReport(data.message);if(!result){return}stackResult=that.obtainStack(data.stack);params=that.createErrorBody({message:data.message,stack:stackResult.stack,line:stackResult.location||data.location,file:stackResult.file||data.file});rate.add(params)&&that.sendBefore(params)}},listenerError:function(){var that=this;window.addEventListener("error",function(oError){var result,stack,params,oBody={message:oError.message,file:oError.filename,line:(oError.lineno||"0")+":"+(oError.colno||"0")};result=that.isCheckKeyToReport(oBody.message);if(!result||!oBody.file){return}try{stack=oError.error.stack}catch(err){stack=""}oBody.stack=stack;params=that.createErrorBody(oBody);rate.add(params)&&that.sendBefore(params)})},unhandledrejectionError:function(){var that=this;window.addEventListener("unhandledrejection",function(event){var result,params,oError=event.reason||{},oBody={message:oError.message,stack:oError.stack,line:"0:0"};result=that.isCheckKeyToReport(oBody.message);if(!result){return}params=that.createErrorBody(oBody);
rate.add(params)&&that.sendBefore(params)})},iframeError:function(){if(!window.frames[0]){return}window.frames[0].onerror=function(event){console.error(event)}},fetchError:function(){},init:function(){this.error();this.listenerError();this.unhandledrejectionError();this.iframeError();this.fetchError();window.ReportFe={setConfig:setConfig,fetchTo:fetchTo}}};errorReport.init()})();(function(win){var locat=win.location;var origin=locat.origin;var reportInterval=1;var longStay=10;var rerpotRate=1000*1*60*60*24*1;var imgType=["png","gif","jpg","jpeg","bmp","svg","pcx","tiff","fpx","hdri","raw"];var config={api:analyses_domain+"/api/v2/fp/add",business_name:"",report_name:"",url:locat.href};var filterFiles=["favicon.ico"];var list=[];var cache={type:0,network:win.networkType,navigation:{},resource:{iframe:{},script:{},img:{},css:{},xmlhttprequest:{},other:{},video:{},audio:{},fetch:{},paint:{}},memory:{}};var init=function(){if(typeof performance.getEntries==="function"){list=performance.getEntries();getResource()}getNavigation();getMemory();cache.type=performance.navigation.type};var setConfig=function(data){if(typeof data!=="object"){return}for(var i in data){config[i]=data[i]}};var getNavigation=function(){var navigation=cache.navigation;if("doc" in navigation){return}list=list[0]||{};performance.timing.transferSize=list.transferSize||0;navigation["doc"]=analysisDoc(performance.timing)};var getResource=function(){var resource=cache.resource;for(var i=0;i<list.length;i++){var timing=list[i];var initiatorType=timing.initiatorType;if(timing.entryType==="navigation"){continue}var newName=timing.name.replace(origin,"");timing.isNew=true;if(timing.entryType==="paint"){initiatorType=timing.entryType}if(initiatorType===""){initiatorType="other"}if(resource[initiatorType]){if(newName in resource[initiatorType]){resource[initiatorType][newName].isNew=false;continue}}if(initiatorType==="css"){var index=newName.lastIndexOf(".");if(index>-1&&imgType.includes(newName.slice(index+1,newName.length))){initiatorType="img";if(newName in resource[initiatorType]){resource[initiatorType][newName].isNew=false;continue}}}if(initiatorType==="link"&&newName.includes(".css")){initiatorType="css";if(newName in resource[initiatorType]){resource[initiatorType][newName].isNew=false;continue}}if(timing.entryType==="paint"){resource[initiatorType][newName]={duration:Number(timing.duration.toFixed(2)),ready:Number(timing.startTime.toFixed(2))};continue}if(resource[initiatorType]){resource[initiatorType][newName]=analysisResource(timing)}}};var getMemory=function(){var values=performance.memory;for(var i in values){cache.memory[i]=formatSize(values[i])}};var getCommonResource=function(timing){var redirect=timing.redirectEnd-timing.redirectStart;var waiting=timing.domainLookupStart-timing.fetchStart;var dns=timing.domainLookupEnd-timing.domainLookupStart;var tcp=timing.connectEnd-timing.connectStart;var ssl=timing.secureConnectionStart?(timing.connectEnd-timing.secureConnectionStart):0;var req=timing.responseStart-timing.requestStart;var res=timing.responseEnd-timing.responseStart;return{redirect:Number(redirect.toFixed(2)),waiting:Number(waiting.toFixed(2)),dns:Number(dns.toFixed(2)),tcp:Number(tcp.toFixed(2)),ssl:Number(ssl.toFixed(2)),req:Number(req.toFixed(2)),res:Number(res.toFixed(2)),}};var analysisResource=function(timing){var data=getCommonResource(timing);data.duration=Number(timing.duration.toFixed(2));data.size=formatSize(timing.transferSize||0);data.isNew=timing.isNew;return data};var analysisDoc=function(timing){var ready=timing.fetchStart-timing.navigationStart;var data=getCommonResource(timing);var white_screen=timing.domLoading-timing.navigationStart;var dom_tree=timing.domInteractive-timing.domLoading;var dom_ready=timing.domContentLoadedEventEnd-timing.navigationStart;var load_event=timing.loadEventEnd-timing.loadEventStart;var load_time=timing.loadEventEnd-timing.navigationStart;data.ready=Number(ready.toFixed(2));data.dom_tree=Number(dom_tree.toFixed(2));data.dom_ready=Number(dom_ready.toFixed(2));data.load_event=Number(load_event.toFixed(2));data.load_time=Number(load_time.toFixed(2));data.size=formatSize(timing.transferSize);data.white_screen=Number(white_screen.toFixed(2));return data};var setReportState=function(){var resource=cache.resource;var doc=cache.navigation.doc;doc.report=true;for(i in resource){if(typeof resource[i]!=="object"){continue}for(j in resource[i]){if(isFileFilter(j)){continue}resource[i][j].report=true}}};var isFileFilter=function(path){var i,isState=false;if(!path){return isState}for(var i=0;i<filterFiles.length;i++){if(path.indexOf(filterFiles[i])>-1){isState=true;break}}return isState};var formatUploadData=function(){var data={},resource=cache.resource,doc=cache.navigation.doc,i,j;doc.method=cache.type;doc.network=cache.network;doc.url=config.url;if(!doc.report){data.Doc=[doc]}var createKey=function(i){var _key=i;if(i==="xmlhttprequest"){_key="xhr"}var key=_key.slice(0,1).toLocaleUpperCase()+_key.slice(1);
data[key]=[];return key};for(i in resource){if(typeof resource[i]!=="object"){continue}var key=createKey(i);for(j in resource[i]){if(isFileFilter(j)){continue}if(resource[i][j].report){continue}resource[i][j].file=j;resource[i][j].network=cache.network;resource[i][j].url=config.url;delete resource[i][j].isNew;data[key].push(resource[i][j])}}data.Other=data.Other.concat(data.Iframe).concat(data.Video).concat(data.Audio);data.Xhr=data.Xhr.concat(data.Fetch);delete data.Iframe;delete data.Fetch;delete data.Audio;delete data.Video;return data};var formatSize=function(size){return Number((size/1024).toFixed(2))};var sendValidate=function(params){var arr=params.data;if(!params.business_name||!params.report_name){return false}var empty=true;for(var i in arr){if(arr[i].length){empty=false}}return !empty};var toPushServer=function(){var data={business_name:config.business_name,report_name:config.report_name,data:formatUploadData()};if(!sendValidate(data)){return}ReportFe.fetchTo(config.api,{data:data,success:function(){setReportState();localStorage.setItem("performance",Date.now())}})};var upRate=function(){var prevTime=localStorage.getItem("performance");if(!prevTime){return true}if(Date.now()-prevTime>rerpotRate){return true}return false};var loop=function(){var count=0;var timer=setInterval(function(){count=count+1;if(count===reportInterval){init();toPushServer()}if(count%longStay===0){init();toPushServer()}},1000)};var perfObserve=function(){if(typeof PerformanceObserver!=="function"){return}var per=new PerformanceObserver(function(list,ob){var entries=list.getEntries();for(var i=0;i<entries.length;i++){console.log(entries[i].name,entries.length,entries[i].entryType)}});per.observe({entryTypes:["paint","navigation","resource","longtask"]})};win.addEventListener("load",function(){loop()},false);win.ReportFp={setConfig:setConfig,cache:cache.resource}})(window);